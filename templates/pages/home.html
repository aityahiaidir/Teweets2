{% extends 'base.html' %} 
{% block head_title %} it's Ammazing !! {% endblock head_title %} 

{% block content %} 

<div class="row text-center">
<div class="col">
 <h3>Welcome to TweetMe 2</h3>
</div>
</div>

<div class="row mb-4">
<div class="col-md-4 mx-auto col-10">
   <form class="form" method="POST" id ="tweet-create-form" action="/create-tweet">
     {% csrf_token %}
     <input type="hidden" name="next" value="/">
     <textarea class="form-control" name="content" id="content" placeholder ="Your tweet..."></textarea>
     <button class="btn btn-primary" type="submit">Tweet</button>
   </form>
 </div>
</div>

<div class="row" id="tweets">
   Replace me
</div> 



<script>

 const tweetsContainerElement = document.getElementById("tweets")
 loadTweets(tweetsContainerElement)

function handleTweetCreateFormDidSubmit(event) {
  event.preventDefault();
  const myForm = event.target;
  const myFormData = new FormData(myForm)
  const url = myForm.getAttribute("action")
  const method = myForm.getAttribute("method")
  const xhr = new XMLHttpRequest();
   const responseType = "json"
  xhr.responseType = responseType
  xhr.open(method, url)
  xhr.setRequestHeader("HTTP_X_REQUESTED_WITH","XMLHttpRequest")
  xhr.setRequestHeader("X-Requested-With","XMLHttpRequest")
  xhr.onload = function () {
    
    if (xhr.status == 201)
    {
      const newTweetJSON = xhr.response
      //const newTweetJSON = JSON.parse(newTweet)
      console.log(newTweetJSON.likes)
      const newTweetElement = formatTweetElement(newTweetJSON)
      tweetsContainerElement.prepend(newTweetElement)


    }
  
  }
   xhr.send(myFormData)
 
  
 
}
const tweetCreateFormEl  =document.getElementById("tweet-create-form")
 tweetCreateFormEl.addEventListener("submit",handleTweetCreateFormDidSubmit)

function loadTweets(tweetsElement) {
  const xhr = new XMLHttpRequest();
  const method = "GET"
  const url = "/tweets"
  const responseType = "json"
  xhr.responseType = responseType
  xhr.open(method, url)
  xhr.onload = function () {
    const serverResonse = xhr.response
    var listedItems = serverResonse.response
    var finalTweetStr =""
    var i;
    for (i=0; i< listedItems.length ; i++)
    {

      var curentItem = formatTweetElement(listedItems[i])
       finalTweetStr += curentItem;
    }

    tweetsContainerElement.innerHTML = finalTweetStr ;

     }
   xhr.send()

}
  

function handleDidLike(tweet_id,currentCount){
  console.log(tweet_id,currentCount)

}

function  likeBtn(tweet) {
return "<Button class ='btn btn-primary btn-sm' onclick=handleDidLike("+tweet.id+","+tweet.likes+")>"+tweet.likes+" Like</Button>" 
}


  function formatTweetElement(tweet) {
    var formatedTweet = "<div class='col-12 col-md-10 mx-auto  border mb-4 py-3 tweet' id = 'tweet-"+
    tweet.id+"'>"+tweet.id+"<p>"+tweet.content+"</p><div class='btn-group'>"+
      likeBtn(tweet)+
    "</div></div>";
    return formatedTweet
  }
  

    
 
</script>
{% endblock content %}
